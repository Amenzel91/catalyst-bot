================================================================================
TICKER EXTRACTION PATTERN MATCHING FLOW
================================================================================

                         INPUT: News Headline
                                  |
                                  v
        ┌─────────────────────────────────────────────────┐
        │         Combined Regex Pattern Matcher          │
        │  (Patterns applied in priority order)           │
        └─────────────────────────────────────────────────┘
                                  |
                ┌─────────────────┴──────────────────┐
                |                                     |
                v                                     v
        ┌───────────────┐                    ┌────────────────┐
        │  PATTERN 1:   │                    │   PATTERN 2:   │
        │  Exchange     │                    │   Company +    │
        │  Qualified    │                    │   Ticker       │
        └───────────────┘                    └────────────────┘
                |                                     |
                v                                     v
        (NASDAQ: AAPL)                       Apple (AAPL)
        (NYSE: TSLA)                         Tesla Inc. (TSLA)
                |                                     |
                |                                     |
                v                                     v
        ┌───────────────┐                    ┌────────────────┐
        │  PATTERN 3:   │                    │   PATTERN 4:   │
        │  Headline     │                    │   Dollar       │
        │  Start        │                    │   Ticker       │
        └───────────────┘                    └────────────────┘
                |                                     |
                v                                     v
        TSLA: Deliveries                     $NVDA shares
        AAPL: Reports                        $AAPL hits
                |                                     |
                └─────────────────┬───────────────────┘
                                  |
                                  v
                        ┌──────────────────┐
                        │ Extract Capture  │
                        │ Groups (ticker)  │
                        └──────────────────┘
                                  |
                                  v
                        ┌──────────────────┐
                        │  Normalize to    │
                        │  Uppercase       │
                        └──────────────────┘
                                  |
                                  v
                        ┌──────────────────┐
                        │  Filter          │
                        │  Exclusions      │
                        └──────────────────┘
                                  |
                    ┌─────────────┴─────────────┐
                    |                           |
                    v                           v
            ┌──────────────┐          ┌──────────────────┐
            │ In Exclusion │  NO      │  Valid Ticker    │
            │    List?     │ ────────>│  (Return)        │
            └──────────────┘          └──────────────────┘
                    | YES
                    v
            ┌──────────────┐
            │   Reject     │
            │  (Return "") │
            └──────────────┘


================================================================================
PATTERN MATCHING DETAILS
================================================================================

┌──────────────────────────────────────────────────────────────────────────┐
│ PATTERN 1: Exchange-Qualified                                            │
├──────────────────────────────────────────────────────────────────────────┤
│ Regex: \b(?:NASDAQ|NYSE|AMEX)\s*[:\-]\s*\$?([A-Z][A-Z0-9.\-]{0,5})\b   │
│                                                                          │
│ Input:  "(Nasdaq: AAPL) announces merger"                               │
│         ↓                                                                │
│ Match:  "(Nasdaq: AAPL)"                                                 │
│         ↓                                                                │
│ Capture Group 1: "AAPL"                                                  │
│         ↓                                                                │
│ Output: AAPL                                                             │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ PATTERN 2: Company + Ticker                                              │
├──────────────────────────────────────────────────────────────────────────┤
│ Regex: [A-Z][A-Za-z0-9&\.\-]*(?:\s+Inc\.?)?\s*\(([A-Z]{2,5})\)         │
│                                                                          │
│ Input:  "Apple (AAPL) Reports Strong Quarter"                           │
│         ↓                                                                │
│ Match:  "Apple (AAPL)"                                                   │
│         ↓                                                                │
│ Capture Group 1: "AAPL"                                                  │
│         ↓                                                                │
│ Output: AAPL                                                             │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ PATTERN 3: Headline Start                                                │
├──────────────────────────────────────────────────────────────────────────┤
│ Regex: ^([A-Z]{2,5}):\s+                                                │
│                                                                          │
│ Input:  "TSLA: Deliveries Beat Estimates"                               │
│         ↓                                                                │
│ Match:  "TSLA:"                                                          │
│         ↓                                                                │
│ Capture Group 1: "TSLA"                                                  │
│         ↓                                                                │
│ Check Exclusions: TSLA NOT in {PRICE, UPDATE, ALERT, ...}               │
│         ↓                                                                │
│ Output: TSLA                                                             │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ PATTERN 4: Dollar Ticker                                                 │
├──────────────────────────────────────────────────────────────────────────┤
│ Regex: (?:(?<!\w)\$([A-Z][A-Z0-9.\-]{0,5})\b)                          │
│                                                                          │
│ Input:  "$NVDA shares surge 15%"                                        │
│         ↓                                                                │
│ Match:  "$NVDA"                                                          │
│         ↓                                                                │
│ Capture Group 1: "NVDA"                                                  │
│         ↓                                                                │
│ Output: NVDA                                                             │
└──────────────────────────────────────────────────────────────────────────┘


================================================================================
EXCLUSION FILTERING
================================================================================

                    ┌──────────────────┐
                    │  Extracted:      │
                    │  "PRICE"         │
                    └──────────────────┘
                            |
                            v
                  ┌──────────────────────┐
                  │ Check Exclusion List │
                  └──────────────────────┘
                            |
                ┌───────────┴───────────┐
                |                       |
                v                       v
        ┌──────────────┐        ┌──────────────┐
        │ "PRICE" in   │  YES   │   REJECT     │
        │ Exclusions?  │ ──────>│   (skip)     │
        └──────────────┘        └──────────────┘
                |
                | NO
                v
        ┌──────────────┐
        │  Valid       │
        │  Ticker      │
        └──────────────┘


Exclusion List:
  PRICE, UPDATE, ALERT, NEWS, WATCH, FLASH, BRIEF,
  CEO, CFO, SEC, FDA, IPO, ETF, USA, UK, AI


================================================================================
DEDUPLICATION FLOW
================================================================================

Multiple patterns may match the same ticker. Deduplication ensures
each ticker appears only once in the output.

Input: "TSLA: Tesla Inc. (TSLA) stock jumps"

         ┌──────────────────────────────────┐
         │  Pattern 3 matches: TSLA         │
         │  Pattern 2 matches: TSLA         │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Seen Set: {}                    │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Add "TSLA" to seen set          │
         │  Output: [TSLA]                  │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Second "TSLA" already in seen   │
         │  Skip (don't add again)          │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Final Output: [TSLA]            │
         └──────────────────────────────────┘


================================================================================
EDGE CASE: Multiple Tickers
================================================================================

Input: "Apple (AAPL) partners with Microsoft (MSFT)"

         ┌──────────────────────────────────┐
         │  Pattern 2 matches: AAPL         │
         │  Pattern 2 matches: MSFT         │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Seen Set: {}                    │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Add "AAPL" to seen set          │
         │  Output: [AAPL]                  │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Add "MSFT" to seen set          │
         │  Output: [AAPL, MSFT]            │
         └──────────────────────────────────┘


================================================================================
EDGE CASE: Class Shares
================================================================================

Input: "Berkshire Hathaway (BRK.A) reports"

Pattern: [A-Z][A-Za-z0-9&\.\-]*\s*\(([A-Z]{2,5}(?:\.[A-Z])?)\)
                                              └──────┘
                                        Allows .A, .B, etc.

         ┌──────────────────────────────────┐
         │  Match: "Berkshire Hathaway      │
         │         (BRK.A)"                 │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Capture Group: "BRK.A"          │
         │  (dot is allowed)                │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Output: BRK.A                   │
         └──────────────────────────────────┘


================================================================================
PATTERN PRIORITY DEMONSTRATION
================================================================================

Why order matters:

Input: "(NASDAQ: AAPL) stock"

CORRECT ORDER (Specific -> General):
  1. Exchange-Qualified  ✓ MATCHES → AAPL
  2. Company + Ticker    (not reached)
  3. Headline Start      (not reached)
  4. Dollar Ticker       (not reached)

WRONG ORDER (General -> Specific):
  1. Dollar Ticker       ✗ NO MATCH
  2. Headline Start      ✗ NO MATCH
  3. Company + Ticker    ✗ NO MATCH
  4. Exchange-Qualified  ✓ MATCHES → AAPL
  (Still works, but less efficient)


Input: "Apple (AAPL) reports"

CORRECT ORDER:
  1. Exchange-Qualified  ✗ NO MATCH
  2. Company + Ticker    ✓ MATCHES → AAPL
  3. Headline Start      (not reached)
  4. Dollar Ticker       (not reached)


================================================================================
FALSE POSITIVE PREVENTION
================================================================================

Input: "PRICE: $150 target set"

         ┌──────────────────────────────────┐
         │  Pattern 3 matches: "PRICE"      │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Normalize: "PRICE"              │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Check Exclusions                │
         │  "PRICE" in {PRICE, UPDATE, ...} │
         └──────────────────────────────────┘
                        |
                        v YES
         ┌──────────────────────────────────┐
         │  REJECT (return "")              │
         └──────────────────────────────────┘
                        |
                        v
         ┌──────────────────────────────────┐
         │  Output: []                      │
         └──────────────────────────────────┘


================================================================================
COMPLETE EXAMPLE
================================================================================

Input: "Apple (AAPL) and Tesla Inc. (TSLA) both report strong earnings"

Step 1: Pattern Matching
  ┌────────────────────────────────────────────┐
  │ Pattern 2 matches:                         │
  │   - "Apple (AAPL)" → capture "AAPL"       │
  │   - "Tesla Inc. (TSLA)" → capture "TSLA"  │
  └────────────────────────────────────────────┘

Step 2: Normalization
  ┌────────────────────────────────────────────┐
  │ Normalize captures:                        │
  │   - "AAPL" → "AAPL"                       │
  │   - "TSLA" → "TSLA"                       │
  └────────────────────────────────────────────┘

Step 3: Exclusion Filtering
  ┌────────────────────────────────────────────┐
  │ Check exclusions:                          │
  │   - "AAPL" NOT in exclusions → KEEP       │
  │   - "TSLA" NOT in exclusions → KEEP       │
  └────────────────────────────────────────────┘

Step 4: Deduplication
  ┌────────────────────────────────────────────┐
  │ Seen set: {}                               │
  │   - Add "AAPL" → seen = {AAPL}            │
  │   - Add "TSLA" → seen = {AAPL, TSLA}      │
  └────────────────────────────────────────────┘

Step 5: Output
  ┌────────────────────────────────────────────┐
  │ Final output: [AAPL, TSLA]                 │
  └────────────────────────────────────────────┘


================================================================================
END OF FLOW DIAGRAM
================================================================================
